<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>결재 작성 · CMMS</title>
    <link rel="stylesheet" href="../../static/assets/css/base.css" />
    <style>
      .editor-toolbar{display:flex;gap:6px;flex-wrap:wrap;border:1px solid var(--border);border-bottom:none;border-radius:6px 6px 0 0;background:var(--bg-subtle);padding:6px}
      .editor-toolbar button{padding:6px 8px}
      .editor{border:1px solid var(--border);border-radius:0 0 6px 6px;min-height:260px;padding:12px;background:var(--surface);}
      .editor:focus{outline:2px solid var(--focus);outline-offset:2px}
      .approver-table th,.approver-table td{text-align:left}
      .approver-controls{display:flex;gap:8px;align-items:end}
      .stack .hint{color:var(--fg-muted);font-size:12px}
      .approver-item{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);border-radius:6px;background:var(--surface);margin-bottom:8px}
      .approver-item .order{flex:0 0 30px;text-align:center;font-weight:bold;color:var(--accent)}
      .approver-item .info{flex:1;display:flex;flex-direction:column;gap:4px}
      .approver-item .member-id{font-weight:bold;color:var(--fg)}
      .approver-item .member-details{font-size:12px;color:var(--fg-muted)}
      .approver-item .decision{flex:0 0 80px;text-align:center}
      .approver-item .actions{flex:0 0 auto;display:flex;gap:4px}
      .approver-item .decision-badge{padding:4px 8px;border-radius:4px;font-size:12px;font-weight:bold}
      .approver-item .decision-badge.approval{background:var(--success-bg);color:var(--success-fg)}
      .approver-item .decision-badge.agree{background:var(--warning-bg);color:var(--warning-fg)}
      .approver-item .decision-badge.inform{background:var(--info-bg);color:var(--info-fg)}
      [data-attachments] { border: none; }
    </style>
  </head>
  <body>
    <div class="page">
      <header class="appbar">
        <div class="appbar-inner">
          <div class="brand">전자결재</div>
          <div class="spacer"></div>
          <div class="meta">
            <span class="badge">작성</span>
          </div>
        </div>
      </header>
      <nav class="breadcrumbs">
        <div class="container">
          <a th:href="@{/}">전자결재</a>
          <span class="sep">/</span>
          <span>결재 작성</span>
        </div>
      </nav>
      <main>
        <div class="container">
          <form class="stack" data-validate method="post" th:action="@{/approval/save}" th:data-redirect="@{/approval/list}">

            <input type="hidden" name="_csrf" value="" data-csrf-field="true" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" name="isNew" th:value="${isNew}" />
            <input type="hidden" id="fileGroupId" name="fileGroupId" th:value="${approval.fileGroupId}" />
            <section class="card">
              <div class="card-header">
                <div class="card-title">결재 작성</div>
                <div class="toolbar">
                  <a class="btn" th:href="@{/approval/list}">목록</a>
                  <button class="btn" type="submit" name="action" value="draft">임시저장</button>
                  <button class="btn primary" type="submit" name="action" value="submit">
                    <span th:text="${isNew ? '상신' : '수정'}">상신</span>
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div class="grid cols-12">
                  <div class="form-row col-span-12">
                    <label class="label" for="title">제목</label>
                    <input id="title" name="title" class="input" type="text" placeholder="제목을 입력하세요" required 
                          th:value="${approval.title}" />
                  </div>
                  <div class="form-row col-span-3">
                    <label class="label" for="refEntity">참조 모듈</label>
                    <select id="refEntity" name="refEntity">
                      <option value="">(선택)</option>
                      <option th:each="module : ${refModules}"
                              th:value="${module.code}"
                              th:text="${module.code + ' - ' + module.name}"
                              th:selected="${approval.refEntity == module.code}">
                      </option>
                    </select>
                  </div>
                  <div class="form-row col-span-3">
                    <label class="label" for="refId">참조 ID</label>
                    <input id="refId" name="refId" class="input" type="text" placeholder="참조 ID" 
                          th:value="${approval.refId}" />
                  </div>
                  <div class="form-row col-span-3">
                    <label class="label" for="status">상태</label>
                    <select id="status" name="status">
                      <option value="">(선택)</option>
                      <option th:each="status : ${statusList}"
                              th:value="${status.code}"
                              th:text="${status.name}"
                              th:selected="${approval.status == status.code}">
                      </option>
                    </select>
                  </div>
                  <!-- 결재선 -->
                  <div class="form-row col-span-12">
                    <label class="label">결재선</label>
                    <div class="approver-controls">
                      <div class="stack">
                        <label class="label" for="member-id-input">결재자 ID</label>
                        <input id="member-id-input" class="input" type="text" placeholder="예: 사용자ID" />
                      </div>
                      <div class="stack">
                        <label class="label" for="decision-select">구분</label>
                        <select id="decision-select">
                          <option value="APPROVAL">결재</option>
                          <option value="AGREE">합의</option>
                          <option value="INFORM">통보</option>
                        </select>
                      </div>
                      <div class="stack">
                        <label class="label" for="">추가</label>
                        <button class="btn" type="button" id="add-approver">추가</button>
                      </div>
                    </div>
                  </div>
                  <div class="form-row col-span-12">
                    <label class="label"></label>
                    <div class="approver-items" id="approver-items" style="margin-top:12px">
                      <div class="empty-message" style="text-align:center;color:var(--fg-muted);padding:24px;border:1px dashed var(--border);border-radius:6px">
                        결재자를 추가하세요.
                      </div>
                    </div>
                  </div>
                  <!-- 본문 -->
                  <div class="form-row col-span-12">
                    <label class="label" for="editor"></label>
                    <div class="editor-toolbar" aria-label="문서 편집기 도구">
                      <button class="btn sm" type="button" data-cmd="bold"><strong>B</strong></button>
                      <button class="btn sm" type="button" data-cmd="italic"><em>I</em></button>
                      <button class="btn sm" type="button" data-cmd="underline"><u>U</u></button>
                      <span class="spacer" style="flex:0 0 12px"></span>
                      <button class="btn sm" type="button" data-cmd="insertUnorderedList">• 목록</button>
                      <button class="btn sm" type="button" data-cmd="insertOrderedList">1. 목록</button>
                      <span class="spacer" style="flex:0 0 12px"></span>
                      <button class="btn sm" type="button" data-cmd="undo">실행취소</button>
                      <button class="btn sm" type="button" data-cmd="redo">다시실행</button>
                    </div>
                  </div>
                  <div class="form-row col-span-12">
                    <label class="label" for="editor">본문</label>
                    <div id="editor" class="editor" contenteditable="true" aria-multiline="true" role="textbox" placeholder="본문을 입력하세요"></div>
                    <textarea id="content" name="content" style="display:none"></textarea>
                  </div>                        

                  <div class="form-row col-span-12" data-attachments>
                    <label class="label"></label>
                    <div class="row" style="gap:8px;align-items:center">
                      <input id="attachments-input" type="file" multiple style="display:none" />
                      <button class="btn" type="button" data-attachments-add>파일 선택</button>
                    </div>
                  </div>
                  <div class="form-row col-span-12">
                    <label class="label"></label>
                    <ul class="attachments-list" style="margin-top:8px; width:100%; box-sizing:border-box">
                      <li class="empty">첨부 파일이 없습니다.</li>
                    </ul>
                  </div>                  
                </div>
              </div>
            </section>
          </form>
        </div>
      </main>
      <footer>
        <div class="container">© 전자결재</div>
      </footer>
    </div>
    <script src="../../static/assets/js/app.js"></script>
    <script>
      // 간단한 에디터 동작
      document.querySelectorAll('.editor-toolbar [data-cmd]').forEach(btn => {
        btn.addEventListener('click', () => {
          const cmd = btn.getAttribute('data-cmd');
          document.execCommand(cmd, false, null);
          document.getElementById('editor').focus();
        });
      });

      // 제출 시 본문 동기화
      const form = document.querySelector('form');
      form.addEventListener('submit', () => {
        document.getElementById('content').value = document.getElementById('editor').innerHTML;
      });

      // 결재선 추가/정렬/삭제
      const approverItems = document.getElementById('approver-items');
      let approverCount = 0;

      // 사용자 정보 조회 (실제로는 API 호출)
      async function fetchMemberInfo(memberId) {
        // 임시 데이터 - 실제로는 API 호출
        const mockData = {
          'admin': { name: '관리자', deptId: 'IT', deptName: 'IT부서' },
          'kim': { name: '김철수', deptId: 'HR', deptName: '인사부서' },
          'lee': { name: '이영희', deptId: 'FN', deptName: '재무부서' },
          'park': { name: '박민수', deptId: 'OP', deptName: '운영부서' }
        };
        return mockData[memberId] || { name: '알 수 없음', deptId: 'N/A', deptName: 'N/A' };
      }

      function renumber() {
        Array.from(approverItems.querySelectorAll('.approver-item')).forEach((item, idx) => {
          const orderElement = item.querySelector('.order');
          if (orderElement) orderElement.textContent = String(idx + 1);
        });
      }

      function ensureNonEmpty() {
        if (!approverItems.querySelector('.approver-item')) {
          const emptyMessage = document.createElement('div');
          emptyMessage.className = 'empty-message';
          emptyMessage.style.cssText = 'text-align:center;color:var(--fg-muted);padding:24px;border:1px dashed var(--border);border-radius:6px';
          emptyMessage.textContent = '결재자를 추가하세요.';
          approverItems.appendChild(emptyMessage);
        }
      }

      function removeEmpty() {
        const empty = approverItems.querySelector('.empty-message');
        if (empty) empty.remove();
      }

      document.getElementById('add-approver').addEventListener('click', async () => {
        const memberIdInput = document.getElementById('member-id-input');
        const decisionSelect = document.getElementById('decision-select');
        const memberId = memberIdInput.value.trim();
        const decision = decisionSelect.value;

        if (!memberId) { 
          alert('결재자 ID를 입력하세요.'); 
          return; 
        }

        // 중복 방지 (같은 사용자+구분)
        const existing = Array.from(approverItems.querySelectorAll('.approver-item')).some(item => 
          item.dataset.memberId === memberId && item.dataset.decision === decision
        );
        if (existing) { 
          alert('이미 추가된 결재자입니다.'); 
          return; 
        }

        // 사용자 정보 조회
        const memberInfo = await fetchMemberInfo(memberId);
        
        removeEmpty();
        const item = document.createElement('div');
        item.className = 'approver-item';
        item.dataset.memberId = memberId;
        item.dataset.decision = decision;
        
        const decisionText = decision === 'APPROVAL' ? '결재' : decision === 'AGREE' ? '합의' : '통보';
        const decisionClass = decision === 'APPROVAL' ? 'approval' : decision === 'AGREE' ? 'agree' : 'inform';
        
        item.innerHTML = `
          <div class="order">${approverCount + 1}</div>
          <div class="info">
            <div class="member-id">${memberId}</div>
            <div class="member-details">${memberInfo.name} / ${memberInfo.deptId} / ${memberInfo.deptName}</div>
          </div>
          <div class="decision">
            <span class="decision-badge ${decisionClass}">${decisionText}</span>
          </div>
          <div class="actions">
            <button class="btn sm" type="button" data-move="up" title="위로">↑</button>
            <button class="btn sm" type="button" data-move="down" title="아래로">↓</button>
            <button class="btn sm danger" type="button" data-remove title="삭제">×</button>
          </div>
        `;
        
        approverItems.appendChild(item);
        approverCount++;
        memberIdInput.value = ''; // 입력 필드 초기화
      });

      approverItems.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const item = btn.closest('.approver-item');
        if (!item) return;

        if (btn.hasAttribute('data-remove')) {
          item.remove(); 
          approverCount--;
          renumber(); 
          ensureNonEmpty(); 
          return;
        }
        
        if (btn.dataset.move === 'up' && item.previousElementSibling) {
          approverItems.insertBefore(item, item.previousElementSibling); 
          renumber(); 
          return;
        }
        
        if (btn.dataset.move === 'down' && item.nextElementSibling) {
          approverItems.insertBefore(item.nextElementSibling, item); 
          renumber(); 
          return;
        }
      });

      // Enter 키로 추가
      document.getElementById('member-id-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('add-approver').click();
        }
      });
    </script>
  </body>
  </html>

